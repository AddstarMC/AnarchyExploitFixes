package me.moomoo.anarchyexploitfixes.modules.chat.commandwhitelist;

import com.comphenix.protocol.PacketType;
import com.comphenix.protocol.ProtocolLibrary;
import com.comphenix.protocol.events.ListenerPriority;
import com.comphenix.protocol.events.PacketAdapter;
import com.comphenix.protocol.events.PacketContainer;
import com.comphenix.protocol.events.PacketEvent;
import me.moomoo.anarchyexploitfixes.AnarchyExploitFixes;
import me.moomoo.anarchyexploitfixes.enums.AEFPermission;
import org.bukkit.entity.Player;

import java.util.Set;

import static me.moomoo.anarchyexploitfixes.utils.CommandUtil.getCommandLabel;

public class CWChatPacketListener extends PacketAdapter {

    /*
     *     Credits go to YouHaveTrouble (https://github.com/YouHaveTrouble/CommandWhitelist)
     *     Code was mainly only implemented into AEF by xGinko.
     */

    private final Set<String> allowedCommands;
    private final Set<String> bannedSubCommands;
    private final boolean shouldLog;

    protected CWChatPacketListener(AnarchyExploitFixes plugin, Set<String> allowedCommands, Set<String> bannedSubCommands, boolean shouldLog) {
        super(plugin, ListenerPriority.HIGHEST, PacketType.Play.Client.CHAT);
        this.allowedCommands = allowedCommands;
        this.bannedSubCommands = bannedSubCommands;
        this.shouldLog = shouldLog;
    }

    protected void register() {
        ProtocolLibrary.getProtocolManager().addPacketListener(this);
    }

    @Override
    public void onPacketReceiving(PacketEvent event) {
        PacketContainer packet = event.getPacket();
        String string = packet.getStrings().read(0);
        if (!string.startsWith("/")) return;
        Player player = event.getPlayer();
        if (player.hasPermission(AEFPermission.BYPASS_CMD_WHITELIST.get())) return;

        if (!allowedCommands.contains(getCommandLabel(string).toLowerCase())) {
            event.setCancelled(true);
            player.sendMessage(AnarchyExploitFixes.getLang(player.getLocale()).chat_CommandWhitelist_BadCommand);
            if (shouldLog)
                AnarchyExploitFixes.getPrefixedLogger().info(player.getName() + " tried to execute a non whitelisted command: " + string);
            return;
        }

        for (String bannedSubCommand : bannedSubCommands) {
            if (string.toLowerCase().substring(1).startsWith(bannedSubCommand)) {
                event.setCancelled(true);
                player.sendMessage(AnarchyExploitFixes.getLang(player.getLocale()).chat_CommandWhitelist_BadCommand);
                if (shouldLog)
                    AnarchyExploitFixes.getPrefixedLogger().info(player.getName() + " tried to execute a blacklisted subcommand: " + string);
                return;
            }
        }
    }
}
