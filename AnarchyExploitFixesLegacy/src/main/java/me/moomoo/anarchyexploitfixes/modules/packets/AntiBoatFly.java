package me.moomoo.anarchyexploitfixes.modules.packets;

import com.github.retrooper.packetevents.PacketEvents;
import com.github.retrooper.packetevents.event.PacketListenerAbstract;
import com.github.retrooper.packetevents.event.PacketListenerPriority;
import com.github.retrooper.packetevents.event.PacketReceiveEvent;
import com.github.retrooper.packetevents.protocol.packettype.PacketType;
import me.moomoo.anarchyexploitfixes.AnarchyExploitFixes;
import me.moomoo.anarchyexploitfixes.config.Config;
import me.moomoo.anarchyexploitfixes.modules.AEFModule;
import me.moomoo.anarchyexploitfixes.utils.EntityUtil;
import org.bukkit.entity.Entity;
import org.bukkit.entity.Player;

import java.util.HashMap;
import java.util.Map;
import java.util.UUID;

public class AntiBoatFly extends PacketListenerAbstract implements AEFModule {

    private final AnarchyExploitFixes plugin;
    private final Map<UUID, Integer> boatLevels = new HashMap<>();
    private final int maxEntityPacketsPer10s;
    private final boolean logIsEnabled, shouldKickPlayer;

    public AntiBoatFly() {
        super(PacketListenerPriority.LOW);
        shouldEnable();
        this.plugin = AnarchyExploitFixes.getInstance();
        Config config = AnarchyExploitFixes.getConfiguration();
        config.addComment(configPath() + ".enable", "Patches Futureclient / Rusherhack boat fly exploit.");
        this.logIsEnabled = config.getBoolean(configPath() + ".log", true);
        this.maxEntityPacketsPer10s = config.getInt(configPath() + ".max-entity-packets-per-10s", 15);
        this.shouldKickPlayer = config.getBoolean(configPath() + ".kick-player-if-boatflying", false);
    }

    @Override
    public String configPath() {
        return "patches.boatfly-patch";
    }

    @Override
    public void enable() {
        PacketEvents.getAPI().getEventManager().registerListener(this);
    }

    @Override
    public boolean shouldEnable() {
        if (AnarchyExploitFixes.getConfiguration().getBoolean(configPath() + ".enable", false)) {
            if (AnarchyExploitFixes.getConfiguration().packet_events_disabled) {
                warn("Not patching exploit because you disabled packets in config!");
                return false;
            }
            return true;
        }
        return false;
    }

    @Override
    public void onPacketReceive(PacketReceiveEvent event) {
        if (event.getPacketType() != PacketType.Play.Client.VEHICLE_MOVE) return;
        final Player player = (Player) event.getPlayer();
        if (player == null) return;
        final Entity vehicle = player.getVehicle();
        if (vehicle == null || !EntityUtil.BOATS.contains(vehicle.getType())) return;

        final UUID uuid = player.getUniqueId();

        if (!boatLevels.containsKey(uuid) || boatLevels.get(uuid) <= maxEntityPacketsPer10s) {
            boatLevels.merge(uuid, 1, Integer::sum);
            plugin.getServer().getScheduler().scheduleSyncDelayedTask(plugin,
                    () -> boatLevels.put(uuid, boatLevels.get(uuid) - 1), 200L);
            return;
        }

        plugin.getServer().getScheduler().runTask(plugin, vehicle::remove);

        if (logIsEnabled)
            info("Prevented player '"+player.getName()+"' from boat flying.");
        if (shouldKickPlayer)
            plugin.getServer().getScheduler().runTask(plugin, () -> player.kickPlayer(AnarchyExploitFixes.getLang(player.getLocale()).misc_MaskedKickMessage));
    }
}
