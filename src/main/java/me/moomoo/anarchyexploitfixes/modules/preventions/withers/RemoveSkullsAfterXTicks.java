package me.moomoo.anarchyexploitfixes.modules.preventions.withers;

import me.moomoo.anarchyexploitfixes.AnarchyExploitFixes;
import me.moomoo.anarchyexploitfixes.config.Config;
import me.moomoo.anarchyexploitfixes.modules.AnarchyExploitFixesModule;
import org.bukkit.entity.Entity;
import org.bukkit.entity.WitherSkull;
import org.bukkit.event.EventHandler;
import org.bukkit.event.EventPriority;
import org.bukkit.event.Listener;
import org.bukkit.event.entity.ProjectileLaunchEvent;
import org.bukkit.scheduler.BukkitScheduler;

public class RemoveSkullsAfterXTicks implements AnarchyExploitFixesModule, Listener {

    private final AnarchyExploitFixes plugin;
    private final BukkitScheduler bukkitScheduler;
    private final long removeDelayInTicks;

    public RemoveSkullsAfterXTicks() {
        this.plugin = AnarchyExploitFixes.getInstance();
        this.bukkitScheduler = plugin.getServer().getScheduler();
        this.removeDelayInTicks = AnarchyExploitFixes.getConfiguration().getInt("preventions.withers.remove-flying-wither-skulls.after-x-ticks.ticks", 200, "200 Ticks = 10 Seconds");
    }

    @Override
    public String name() {
        return "remove-flying-wither-skulls.after-x-ticks";
    }

    @Override
    public String category() {
        return "preventions";
    }

    @Override
    public void enable() {
        AnarchyExploitFixes plugin = AnarchyExploitFixes.getInstance();
        plugin.getServer().getPluginManager().registerEvents(this, plugin);
    }

    @Override
    public boolean shouldEnable() {
        Config config = AnarchyExploitFixes.getConfiguration();
        if (config.getBoolean("preventions.withers.remove-flying-wither-skulls.remove-all-flying-skulls", false)) return false;
        return config.getBoolean("preventions.withers.remove-flying-wither-skulls.after-x-ticks.enable", true, "Remove wither skulls that have been flying for too long to prevent them from causing lag.");
    }

    @EventHandler(priority = EventPriority.NORMAL, ignoreCancelled = true)
    private void onProjectileLaunch(ProjectileLaunchEvent event) {
        Entity entity = event.getEntity();
        if (entity instanceof WitherSkull) {
            bukkitScheduler.runTaskLater(plugin, entity::remove, removeDelayInTicks);
        }
    }
}
