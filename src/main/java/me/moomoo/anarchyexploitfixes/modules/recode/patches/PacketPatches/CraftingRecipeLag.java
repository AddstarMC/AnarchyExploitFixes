package me.moomoo.anarchyexploitfixes.modules.recode.patches.PacketPatches;

import com.comphenix.protocol.PacketType;
import com.comphenix.protocol.ProtocolLibrary;
import com.comphenix.protocol.events.ListenerPriority;
import com.comphenix.protocol.events.PacketAdapter;
import com.comphenix.protocol.events.PacketEvent;
import me.moomoo.anarchyexploitfixes.AnarchyExploitFixes;
import me.moomoo.anarchyexploitfixes.config.Config;
import me.moomoo.anarchyexploitfixes.modules.AnarchyExploitFixesModule;
import org.bukkit.Bukkit;
import org.bukkit.entity.Player;
import org.bukkit.scheduler.BukkitScheduler;

import java.util.HashSet;
import java.util.UUID;

public class CraftingRecipeLag implements AnarchyExploitFixesModule {

    private final BukkitScheduler bukkitScheduler;
    private final HashSet<UUID> crafting = new HashSet<>();
    private final long craftingRecipeDelay;

    public CraftingRecipeLag() {
        this.bukkitScheduler = Bukkit.getScheduler();
        this.craftingRecipeDelay = AnarchyExploitFixes.getConfiguration().getInt("patches.prevent-crafting-recipe-lag-exploit.crafting-recipe-delay-in-ticks", 5);
    }

    @Override
    public void enable() {
        AnarchyExploitFixes plugin = AnarchyExploitFixes.getInstance();
        ProtocolLibrary.getProtocolManager().addPacketListener(new PacketAdapter(
                plugin, ListenerPriority.NORMAL, PacketType.Play.Client.AUTO_RECIPE
        ) {
            @Override
            public void onPacketReceiving(PacketEvent event) {
                if (event.isPlayerTemporary()) return;

                Player player = event.getPlayer();
                UUID playerUniqueID = player.getUniqueId();

                if (crafting.contains(playerUniqueID)) {
                    event.setCancelled(true);
                } else {
                    crafting.add(playerUniqueID);
                    bukkitScheduler.runTaskLater(
                            plugin, () -> crafting.remove(playerUniqueID), craftingRecipeDelay
                    );
                }
            }
        });
        plugin.enabledModules.add("(Patches) Prevent Crafting-Recipe Lag Exploit");
    }

    @Override
    public boolean shouldEnable() {
        Config config = AnarchyExploitFixes.getConfiguration();
        if (config.protocolLib_IsDisabled) {
            Bukkit.getLogger().warning("Not patching CraftingRecipe Lag-Exploit because ProtocolLib is disabled in config.");
            return false;
        } else {
            if (!Bukkit.getPluginManager().isPluginEnabled("ProtocolLib")) {
                Bukkit.getLogger().warning("Unable to patch CraftingRecipe Lag-Exploit because ProtocolLib is not installed!");
                return false;
            } else {
                return config.getBoolean("patches.prevent-crafting-recipe-lag-exploit.enable", true);
            }
        }
    }
}
