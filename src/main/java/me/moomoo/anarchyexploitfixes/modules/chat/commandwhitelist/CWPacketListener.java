package me.moomoo.anarchyexploitfixes.modules.chat.commandwhitelist;

import com.comphenix.protocol.PacketType;
import com.comphenix.protocol.ProtocolLibrary;
import com.comphenix.protocol.events.ListenerPriority;
import com.comphenix.protocol.events.PacketAdapter;
import com.comphenix.protocol.events.PacketContainer;
import com.comphenix.protocol.events.PacketEvent;
import me.moomoo.anarchyexploitfixes.AnarchyExploitFixes;
import org.bukkit.ChatColor;
import org.bukkit.entity.Player;

import java.util.HashSet;

public class CWPacketListener {

    /*
     *     Credits go to YouHaveTrouble (https://github.com/YouHaveTrouble/CommandWhitelist)
     *     Code was mainly only implemented into AEF by xGinko.
     */

    protected CWPacketListener(
            final HashSet<String> allowedCommands,
            final HashSet<String> bannedSubCommands
    ) {
        ProtocolLibrary.getProtocolManager().addPacketListener(new PacketAdapter(
                AnarchyExploitFixes.getInstance(), ListenerPriority.HIGHEST, PacketType.Play.Client.CHAT
        ) {
            @Override
            public void onPacketReceiving(PacketEvent event) {
                PacketContainer packet = event.getPacket();
                String string = packet.getStrings().read(0);
                if (!string.startsWith("/")) return;
                Player player = event.getPlayer();
                if (player.hasPermission("anarchyexploitfixes.commandwhitelistbypass")) return;

                String caseSensitiveLabel = getCommandLabel(string);
                String label = caseSensitiveLabel.toLowerCase();
                packet.getStrings().write(0, string.replaceFirst(caseSensitiveLabel, label));

                if (!allowedCommands.contains(label)) {
                    event.setCancelled(true);
                    player.sendMessage(ChatColor.translateAlternateColorCodes('&',
                            AnarchyExploitFixes.getLang(player.getLocale()).command_Whitelist_BadCommand)
                    );
                    return;
                }

                for (String bannedSubCommand : bannedSubCommands) {
                    if (string.toLowerCase().substring(1).startsWith(bannedSubCommand)) {
                        event.setCancelled(true);
                        player.sendMessage(ChatColor.translateAlternateColorCodes('&',
                                AnarchyExploitFixes.getLang(player.getLocale()).command_Whitelist_BadCommand)
                        );
                        return;
                    }
                }
            }
        });
    }

    private String getCommandLabel(String cmd) {
        String[] parts = cmd.split(" ");
        if (parts[0].startsWith("/"))
            parts[0] = parts[0].substring(1);
        return parts[0];
    }
}
