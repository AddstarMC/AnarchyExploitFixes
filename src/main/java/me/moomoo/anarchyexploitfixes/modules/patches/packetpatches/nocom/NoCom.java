package me.moomoo.anarchyexploitfixes.modules.patches.packetpatches.nocom;

import com.comphenix.protocol.PacketType;
import com.comphenix.protocol.ProtocolLibrary;
import com.comphenix.protocol.events.ListenerPriority;
import com.comphenix.protocol.events.PacketAdapter;
import com.comphenix.protocol.events.PacketContainer;
import com.comphenix.protocol.events.PacketEvent;
import com.comphenix.protocol.wrappers.BlockPosition;
import com.comphenix.protocol.wrappers.EnumWrappers;
import me.moomoo.anarchyexploitfixes.AnarchyExploitFixes;
import me.moomoo.anarchyexploitfixes.config.Config;
import me.moomoo.anarchyexploitfixes.modules.AnarchyExploitFixesModule;
import me.moomoo.anarchyexploitfixes.modules.patches.packetpatches.nocom.packetwrapper.WrapperPlayClientBlockDig;
import me.moomoo.anarchyexploitfixes.modules.patches.packetpatches.nocom.packetwrapper.WrapperPlayClientUseItem;

public class NoCom implements AnarchyExploitFixesModule {

    private final AnarchyExploitFixes plugin;
    private final int noComMaxDistance;

    public NoCom() {
        shouldEnable();
        this.plugin = AnarchyExploitFixes.getInstance();
        Config config = AnarchyExploitFixes.getConfiguration();
        config.addComment("patches.prevent-nocom-coordinate-exploit.enable",  "Prevent the NoCom Coordinate exploit.");
        this.noComMaxDistance = config.getInt("patches.prevent-nocom-coordinate-exploit.nocom-max-distance", 64);
    }

    @Override
    public String name() {
        return "prevent-nocom-coordinate-exploit";
    }

    @Override
    public String category() {
        return "patches";
    }

    @Override
    public void enable() {
        if (AnarchyExploitFixes.getMCVersion() >= 17) return;

        // Code by John200410 (https://github.com/oldfagorg/CoordinateExploitFix)
        ProtocolLibrary.getProtocolManager().addPacketListener(new PacketAdapter(
                plugin, ListenerPriority.NORMAL, PacketType.Play.Client.BLOCK_DIG
        ) {
            @Override
            public void onPacketReceiving(PacketEvent event) {
                if(event.getPlayer() == null || event.isPlayerTemporary()) return;

                final PacketContainer packet = event.getPacket();
                final WrapperPlayClientBlockDig wrappedPacket = new WrapperPlayClientBlockDig(packet);
                final EnumWrappers.PlayerDigType type = wrappedPacket.getStatus();

                if(
                        type.equals(EnumWrappers.PlayerDigType.START_DESTROY_BLOCK)
                        || type.equals(EnumWrappers.PlayerDigType.ABORT_DESTROY_BLOCK)
                        || type.equals(EnumWrappers.PlayerDigType.STOP_DESTROY_BLOCK)
                ) {
                    final BlockPosition blockPos = wrappedPacket.getLocation();
                    final double distance = event.getPlayer().getLocation().distance(blockPos.toLocation(event.getPlayer().getWorld()));

                    if(distance > noComMaxDistance) {
                        event.setCancelled(true);
                    }
                }
            }
        });

        // Bypass - Causing errors on 1.17.1. - Please let me know if there is a way to fix this.
        // https://paste.ee/p/BdWAH Shouldn't be much of an issue as I believe nocom is fixed in newer versions of Paper.
        if (AnarchyExploitFixes.getMCVersion() > 12) return;
        ProtocolLibrary.getProtocolManager().addPacketListener(new PacketAdapter(
                plugin, ListenerPriority.NORMAL, PacketType.Play.Client.USE_ITEM
        ) {
            @Override
            public void onPacketReceiving(PacketEvent event) {
                if (event.getPlayer() == null || event.isPlayerTemporary()) return;

                final PacketContainer packet = event.getPacket();
                final WrapperPlayClientUseItem wrappedPacket = new WrapperPlayClientUseItem(packet);

                final BlockPosition blockPos = wrappedPacket.getLocation();
                final double distance = event.getPlayer().getLocation().distance(blockPos.toLocation(event.getPlayer().getWorld()));

                if (distance > noComMaxDistance) {
                    event.setCancelled(true);
                }
            }
        });
    }

    @Override
    public boolean shouldEnable() {
        int mcVersion = AnarchyExploitFixes.getMCVersion();
        if (AnarchyExploitFixes.getConfiguration().getBoolean("patches.prevent-nocom-coordinate-exploit.enable", true)) {
            if (mcVersion == 17 && !plugin.getServer().getVersion().contains("1.17.1")) {
                AnarchyExploitFixes.getLog().warning("("+name()+") Please use Paper version 1.17.1 to patch NoCom Exploit. Patch will not be applied to avoid errors.");
                return false;
            }
            return mcVersion >= 12 && mcVersion < 17;
        } else {
            return false;
        }
    }
}
