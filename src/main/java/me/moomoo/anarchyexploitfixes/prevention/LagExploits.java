package me.moomoo.anarchyexploitfixes.prevention;

import me.moomoo.anarchyexploitfixes.Main;
import org.bukkit.Bukkit;
import org.bukkit.configuration.file.FileConfiguration;
import org.bukkit.entity.Player;
import org.bukkit.event.EventHandler;
import org.bukkit.event.Listener;
import org.bukkit.event.block.BlockPhysicsEvent;
import org.bukkit.event.entity.ProjectileLaunchEvent;

import java.awt.*;
import java.util.HashSet;

public class LagExploits implements Listener {
    private final Main plugin;

    public LagExploits(Main plugin) {
        this.plugin = plugin;
    }

    @EventHandler
    private void onEntityChange(BlockPhysicsEvent evt) {
        FileConfiguration config = plugin.getConfig();

        double tps_double = Bukkit.getServer().getTPS()[0];
        if (tps_double < config.getDouble("FallingBlocks")) {
            evt.setCancelled(true);
        }
    }
    HashSet<String> throwcooldown = new HashSet<>();
    @EventHandler
    private void onThrow(ProjectileLaunchEvent evt){
        if(plugin.config.getBoolean("PreventSnowBallExploit")){
            for (Player p : Bukkit.getOnlinePlayers()) {
                Point p1 = new Point(evt.getEntity().getLocation().getBlockX(), evt.getEntity().getLocation().getBlockZ());
                Point p2 = new Point(p.getLocation().getBlockX(), p.getLocation().getBlockZ());
                if(p1.distance(p2) <= 1){
                    if(throwcooldown.contains(p.getName())){
                        evt.setCancelled(true);
                    } else {
                        throwcooldown.add(p.getName());
                        Bukkit.getServer().getScheduler().runTaskLater(plugin, () -> throwcooldown.remove(p.getName()), 6L);
                    }
                }
            }
        }
    }
}
