package me.moomoo.anarchyexploitfixes;

import org.bukkit.Material;
import org.bukkit.block.BlockFace;
import org.bukkit.configuration.file.FileConfiguration;
import org.bukkit.event.EventHandler;
import org.bukkit.event.Listener;
import org.bukkit.event.player.PlayerBucketEmptyEvent;

public class EndPortalPatch implements Listener {
    FileConfiguration config = Main.getPlugin(Main.class).getConfig();
    @EventHandler
    private void onPlayerBucketEvent(PlayerBucketEmptyEvent evt) {
        if (config.getBoolean("PreventDestroyingEndPortals")) {
            String playerName = evt.getPlayer().getName();
            Material type = evt.getBlockClicked().getType();
            BlockFace face = evt.getBlockFace();
            String world = evt.getBlockClicked().getWorld().getName();

            if (config.getBoolean("DEBUG")) {
                Main.getPlugin(Main.class).getLogger().info("PlayerBucketEmptyEvent " + face + " " + type);
            }

            final boolean isAround = face == BlockFace.NORTH || face == BlockFace.EAST || face == BlockFace.SOUTH || face == BlockFace.WEST;

            if (type == Material.BEDROCK) {
                if (world.equalsIgnoreCase("world_the_end")) {
                    if (isAround) {
                        evt.setCancelled(true);
                        Main.getPlugin(Main.class).getLogger().info("Prevented " + playerName + " from destroying a portal!");
                    }
                }
            }

            if (type == Material.ENDER_PORTAL_FRAME) {
                if (isAround) {
                    evt.setCancelled(true);
                    Main.getPlugin(Main.class).getLogger().info("Prevented " + playerName + " from destroying a portal!");
                }
            }

            if (face == BlockFace.UP || face == BlockFace.DOWN) {
                if (evt.getPlayer().getWorld().getBlockAt(evt.getBlockClicked().getX(), evt.getBlockClicked().getY() - 1, evt.getBlockClicked().getZ()).getType() == Material.ENDER_PORTAL || evt.getPlayer().getWorld().getBlockAt(evt.getBlockClicked().getX(), evt.getBlockClicked().getY() + 1, evt.getBlockClicked().getZ()).getType() == Material.ENDER_PORTAL) {
                    evt.setCancelled(true);
                    Main.getPlugin(Main.class).getLogger().info("Prevented " + playerName + " from destroying a portal!");
                }
            }
        }
    }
}
