package me.moomoo.anarchyexploitfixes.patches;

import me.moomoo.anarchyexploitfixes.Main;
import org.bukkit.Material;
import org.bukkit.block.BlockFace;
import org.bukkit.configuration.file.FileConfiguration;
import org.bukkit.event.EventHandler;
import org.bukkit.event.Listener;
import org.bukkit.event.player.PlayerBucketEmptyEvent;

public class EndPortalPatch implements Listener {
    private final Main plugin;

    public EndPortalPatch(Main plugin) {
        this.plugin = plugin;
    }

    @EventHandler
    private void onPlayerBucketEvent(PlayerBucketEmptyEvent evt) {
        FileConfiguration config = plugin.getConfig();

        if (config.getBoolean("PreventDestroyingEndPortals")) {
            String playerName = evt.getPlayer().getName();
            Material type = evt.getBlockClicked().getType();
            BlockFace face = evt.getBlockFace();
            String world = evt.getBlockClicked().getWorld().getName();

            if (config.getBoolean("DEBUG")) {
                plugin.getLogger().info("PlayerBucketEmptyEvent " + face + " " + type);
            }

            final boolean isAround = face == BlockFace.NORTH || face == BlockFace.EAST || face == BlockFace.SOUTH || face == BlockFace.WEST;

            if (type == Material.BEDROCK) {
                if (world.equalsIgnoreCase("world_the_end")) {
                    if (isAround) {
                        evt.setCancelled(true);
                        plugin.getLogger().info("Prevented " + playerName + " from destroying a portal!");
                    }
                }
            }

            if (type == Material.ENDER_PORTAL_FRAME) {
                if (isAround) {
                    evt.setCancelled(true);
                    plugin.getLogger().info("Prevented " + playerName + " from destroying a portal!");
                }
            }

            if (face == BlockFace.UP || face == BlockFace.DOWN) {
                if (evt.getPlayer().getWorld().getBlockAt(evt.getBlockClicked().getX(), evt.getBlockClicked().getY() - 1, evt.getBlockClicked().getZ()).getType() == Material.ENDER_PORTAL || evt.getPlayer().getWorld().getBlockAt(evt.getBlockClicked().getX(), evt.getBlockClicked().getY() + 1, evt.getBlockClicked().getZ()).getType() == Material.ENDER_PORTAL) {
                    evt.setCancelled(true);
                    plugin.getLogger().info("Prevented " + playerName + " from destroying a portal!");
                }
            }
        }
    }
}
